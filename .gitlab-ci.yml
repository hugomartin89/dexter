image: openjdk:8

stages:
  - test
  - build
  - pack

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle

cache:
  paths:
    - .gradle/wrapper
    - .gradle/caches

check:all:
  stage: test
  script:
    - ./gradlew check

build:desktop:
  stage: build
  only:
    - master

  artifacts:
    paths:
      - desktop/build/libs/*.jar
    expire_in: 1 week

  script:
    - ./gradlew desktop:dist

pack:all:
  stage: pack
  dependencies:
    - build:desktop
  only:
    - master

  artifacts:
    paths:
      - dist/

  before_script:
    - apt-get update && apt-get install zip
    - wget -nv https://libgdx.badlogicgames.com/ci/packr/packr.jar
    - wget -nv https://bitbucket.org/alexkasko/openjdk-unofficial-builds/downloads/openjdk-1.7.0-u80-unofficial-linux-i586-image.zip
    - wget -nv https://bitbucket.org/alexkasko/openjdk-unofficial-builds/downloads/openjdk-1.7.0-u80-unofficial-linux-amd64-image.zip
    - wget -nv https://bitbucket.org/alexkasko/openjdk-unofficial-builds/downloads/openjdk-1.7.0-u80-unofficial-windows-i586-image.zip
    - wget -nv https://bitbucket.org/alexkasko/openjdk-unofficial-builds/downloads/openjdk-1.7.0-u80-unofficial-windows-amd64-image.zip
    - mkdir dist

  script:
    - java -jar packr.jar --platform=linux32 --jdk=openjdk-1.7.0-u80-unofficial-linux-i586-image.zip --output dexter-linux32 packr.json
    - java -jar packr.jar --platform=linux64 --jdk=openjdk-1.7.0-u80-unofficial-linux-amd64-image.zip --output dexter-linux64 packr.json
    - java -jar packr.jar --platform=windows32 --jdk=openjdk-1.7.0-u80-unofficial-windows-i586-image.zip --output dexter-win32 packr.json
    - java -jar packr.jar --platform=windows64 --jdk=openjdk-1.7.0-u80-unofficial-windows-amd64-image.zip --output dexter-win64 packr.json
    - zip -r dist/dexter-linux32.zip dexter-linux32
    - zip -r dist/dexter-linux64.zip dexter-linux64
    - zip -r dist/dexter-win32.zip dexter-win32
    - zip -r dist/dexter-win64.zip dexter-win64
